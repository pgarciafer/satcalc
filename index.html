<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Satellite Calculator Look Angle</title>
  <style>
    :root{font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    body{display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;background:linear-gradient(180deg,#f8fafc,#eef2ff)}
    .card{background:#ffffff;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.08);padding:20px;max-width:600px;width:95%;}
    h1{font-size:18px;margin:0 0 16px;color:#0f172a;text-align:center}
    .coords{display:flex;flex-direction:column;gap:12px;margin-top:12px}
    .coord-item{display:flex;align-items:center;gap:8px;background:#f8fafc;padding:8px 12px;border-radius:8px}
    .coord-item label{width:140px;color:#0f172a;font-weight:500;}
    .coord-item input{flex:1;text-align:center;border:none;background:transparent;font-size:18px;color:#0f172a;outline:none;appearance:textfield;}
    .coord-item input:focus{background:#e0f2fe;}
    .coord-item input::-webkit-outer-spin-button,
    .coord-item input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .coord-item select{font-size:16px;padding:4px 6px;border-radius:6px;border:1px solid #cbd5e1;background:white;color:#0f172a;}
    .muted{color:#94a3b8;font-size:13px;margin-top:12px;text-align:center}
    .actions{display:flex;gap:8px;margin-top:14px;justify-content:center}
    button{padding:8px 12px;border-radius:8px;border:0;background:#0ea5a4;color:white;cursor:pointer;font-weight:500}
    button.secondary{background:#64748b}
    .error{color:#b91c1c}
    .diagrams{display:flex;flex-wrap:wrap;gap:20px;justify-content:center;margin-top:20px}
    .diagram{display:flex;flex-direction:column;align-items:center}
    canvas{background:white;border-radius:8px;}

    /* Responsive behavior */
    @media (max-width: 600px){
      .diagrams{flex-direction:column;align-items:center}
      canvas{width:100% !important;height:auto !important;max-width:300px}
    }
    @media (min-width: 601px){
      .diagrams{flex-direction:row;justify-content:space-around}
      canvas{width:180px;height:180px}
    }
  </style>
</head>
<body>
  <div class="card" role="region" aria-label="Device coordinates">
    <h1>Satellite Calculator Look Angle</h1>

    <div class="coords" aria-live="polite">
      <div class="coord-item">
        <label for="lat">Latitude</label>
        <input id="lat" type="text" inputmode="decimal" placeholder="0.00" />
        <select id="latDir">
          <option value="N">N</option>
          <option value="S">S</option>
        </select>
      </div>

      <div class="coord-item">
        <label for="lon">Longitude</label>
        <input id="lon" type="text" inputmode="decimal" placeholder="0.00" />
        <select id="lonDir">
          <option value="E">E</option>
          <option value="W">W</option>
        </select>
      </div>

      <div class="coord-item">
        <label for="satLon">Satellite Longitude</label>
        <input id="satLon" type="text" inputmode="decimal" value="18.00" />
        <select id="satLonDir">
          <option value="E">E</option>
          <option value="W">W</option>
        </select>
      </div>

      <div class="coord-item">
        <label for="heading">Heading</label>
        <input id="heading" type="text" inputmode="decimal" value="0.00" />
      </div>
    </div>

    <div class="actions">
      <button id="refreshBtn">Refresh</button>
      <button id="copyBtn" class="secondary" disabled>Copy</button>
    </div>

    <div class="muted" id="status">Waiting for location permission...</div>

    <div class="diagrams">
      <div class="diagram"><div id="azVal">AZ=</div><canvas id="azCanvas" width="200" height="200"></canvas></div>
      <div class="diagram"><div id="elVal">EL=</div><canvas id="elCanvas" width="200" height="200"></canvas></div>
      <div class="diagram"><div id="relVal">REL=</div><canvas id="relCanvas" width="200" height="200"></canvas></div>
    </div>
  </div>

  <script>
    const latEl = document.getElementById('lat');
    const lonEl = document.getElementById('lon');
    const latDir = document.getElementById('latDir');
    const lonDir = document.getElementById('lonDir');
    const satLonEl = document.getElementById('satLon');
    const satLonDir = document.getElementById('satLonDir');
    const headingEl = document.getElementById('heading');
    const statusEl = document.getElementById('status');
    const refreshBtn = document.getElementById('refreshBtn');
    const copyBtn = document.getElementById('copyBtn');

    const azVal = document.getElementById('azVal');
    const elVal = document.getElementById('elVal');
    const relVal = document.getElementById('relVal');

    const azCanvas = document.getElementById('azCanvas');
    const elCanvas = document.getElementById('elCanvas');
    const relCanvas = document.getElementById('relCanvas');
    const azCtx = azCanvas.getContext('2d');
    const elCtx = elCanvas.getContext('2d');
    const relCtx = relCanvas.getContext('2d');

    function showStatus(msg, isError=false){
      statusEl.textContent = msg;
      statusEl.classList.toggle('error', !!isError);
    }

    function normalizeInput(input, max){
      let val = input.value;
      if(val === '') return;
      let num = parseFloat(val);
      if(isNaN(num)) return;
      if(num > max) num = max;
      if(num < 0) num = 0;
      input.value = num.toFixed(2);
    }

    function getLatLon(){
      const latVal = parseFloat(latEl.value) || 0;
      const lonVal = parseFloat(lonEl.value) || 0;
      const satLonVal = parseFloat(satLonEl.value) || 0;
      const headingVal = parseFloat(headingEl.value) || 0;
      const lat = latDir.value === 'N' ? latVal : -latVal;
      const lon = lonDir.value === 'E' ? lonVal : -lonVal;
      const satLon = satLonDir.value === 'E' ? satLonVal : -satLonVal;
      return { lat, lon, satLon, heading: headingVal };
    }

    // ---------- VECTOR METHOD (ENU/topocentric) - REPLACED CALCULATION ----------
    function calcAzEl(lat, lon, satLon){
      // Earth radius and GEO height (km)
      const Re = 6378.137;
      const h = 35786.0;

      // convert to radians
      const latR = lat * Math.PI/180;
      const lonR = lon * Math.PI/180;
      const satLonR = satLon * Math.PI/180;

      // observer ECEF
      const xObs = Re * Math.cos(latR) * Math.cos(lonR);
      const yObs = Re * Math.cos(latR) * Math.sin(lonR);
      const zObs = Re * Math.sin(latR);

      // satellite ECEF (geostationary on equatorial plane)
      const xSat = (Re + h) * Math.cos(satLonR);
      const ySat = (Re + h) * Math.sin(satLonR);
      const zSat = 0;

      // line-of-sight vector from observer to satellite
      const dx = xSat - xObs;
      const dy = ySat - yObs;
      const dz = zSat - zObs;

      // rotate LOS into local ENU (East, North, Up)
      // East
      const e = -Math.sin(lonR) * dx + Math.cos(lonR) * dy;
      // North
      const n = -Math.sin(latR) * Math.cos(lonR) * dx
                - Math.sin(latR) * Math.sin(lonR) * dy
                + Math.cos(latR) * dz;
      // Up
      const u =  Math.cos(latR) * Math.cos(lonR) * dx
               + Math.cos(latR) * Math.sin(lonR) * dy
               + Math.sin(latR) * dz;

      // azimuth: angle East of North
      let az = Math.atan2(e, n) * 180 / Math.PI;
      if (az < 0) az += 360;

      // elevation
      const el = Math.atan2(u, Math.sqrt(e*e + n*n)) * 180 / Math.PI;

      return { az, el };
    }
    // -------------------------------------------------------------------------

    function drawAz(az){
      azCtx.clearRect(0,0,200,200);
      azCtx.strokeStyle = 'black';
      azCtx.beginPath();
      azCtx.arc(100,100,80,0,2*Math.PI);
      azCtx.stroke();
      const rad = (az-90)*Math.PI/180;
      azCtx.strokeStyle = 'blue';
      azCtx.beginPath();
      azCtx.moveTo(100,100);
      azCtx.lineTo(100+70*Math.cos(rad),100+70*Math.sin(rad));
      azCtx.stroke();
    }

    function drawEl(el){
      elCtx.clearRect(0,0,200,200);
      elCtx.strokeStyle = 'black';
      elCtx.beginPath();
      elCtx.arc(100,100,80,0,-Math.PI/2,true);
      elCtx.stroke();

      elCtx.fillStyle = 'black';
      elCtx.font = '12px sans-serif';
      elCtx.textAlign = 'center';
      elCtx.textBaseline = 'middle';
      // tick labels (inside the arc)
      // 0° at right (horizon), 45° diagonal, 90° top (vertical)
      elCtx.fillText('0', 100 + 80*Math.cos(0) - 18, 100 + 80*Math.sin(0));     // right
      elCtx.fillText('45', 100 + 80*Math.cos(-Math.PI/4) - 18, 100 + 80*Math.sin(-Math.PI/4) - 6); // diag
      elCtx.fillText('90', 100 + 80*Math.cos(-Math.PI/2), 100 + 80*Math.sin(-Math.PI/2) + 8); // top

      if(el<0 || el>90){
        elVal.textContent = 'EL=Out of range';
        return;
      }
      elVal.textContent = 'EL='+el.toFixed(2);

      // 0° => right, 90° => up
      const rad = el * Math.PI/180;
      const x = 100 + 70 * Math.cos(rad);
      const y = 100 - 70 * Math.sin(rad);

      elCtx.strokeStyle = 'blue';
      elCtx.beginPath();
      elCtx.moveTo(100,100);
      elCtx.lineTo(x,y);
      elCtx.stroke();
    }

    function drawRel(rel){
      relCtx.clearRect(0,0,200,200);
      relCtx.strokeStyle = 'black';
      relCtx.strokeRect(60,40,80,120);
      relCtx.fillStyle='black';
      relCtx.beginPath();
      relCtx.moveTo(100,20);relCtx.lineTo(90,40);relCtx.lineTo(110,40);relCtx.closePath();
      relCtx.fill();
      relVal.textContent = 'REL='+rel.toFixed(2);
      const rad=(rel-90)*Math.PI/180;
      relCtx.strokeStyle='blue';
      relCtx.beginPath();
      relCtx.moveTo(100,100);
      relCtx.lineTo(100+70*Math.cos(rad),100+70*Math.sin(rad));
      relCtx.stroke();
    }

    function updateAll(){
      const {lat,lon,satLon,heading} = getLatLon();
      const {az,el} = calcAzEl(lat,lon,satLon);
      azVal.textContent = 'AZ='+az.toFixed(2);
      drawAz(az);
      drawEl(el);
      const rel = ((az-heading)+360)%360;
      drawRel(rel);
    }

    async function getAndShowLocation(){
      showStatus('Requesting location...');
      copyBtn.disabled = true;
      if (!('geolocation' in navigator)){
        showStatus('Geolocation API not supported.', true);
        return;
      }
      const opts = { enableHighAccuracy: true, maximumAge: 0, timeout: 20000 };
      return new Promise((resolve) => {
        navigator.geolocation.getCurrentPosition(
          pos => {
            const coords = pos.coords;
            latEl.value = Math.abs(coords.latitude).toFixed(2);
            latDir.value = coords.latitude>=0?'N':'S';
            lonEl.value = Math.abs(coords.longitude).toFixed(2);
            lonDir.value = coords.longitude>=0?'E':'W';
            copyBtn.disabled = false;
            showStatus(`Location loaded (±${Math.round(coords.accuracy)} m).`);
            updateAll();
            resolve(coords);
          },
          err => {
            showStatus('Location error: '+err.message,true);
            resolve(null);
          },
          opts
        );
      });
    }

    window.addEventListener('DOMContentLoaded', () => { getAndShowLocation(); });
    refreshBtn.addEventListener('click', () => { getAndShowLocation(); });

    copyBtn.addEventListener('click', async () => {
      const { lat, lon, satLon } = getLatLon();
      const text = `${Math.abs(lat).toFixed(2)}° ${lat>=0?'N':'S'}, ${Math.abs(lon).toFixed(2)}° ${lon>=0?'E':'W'}, Sat: ${Math.abs(satLon).toFixed(2)}° ${satLon>=0?'E':'W'}`;
      try{
        await navigator.clipboard.writeText(text);
        copyBtn.textContent='Copied!';
        setTimeout(()=>copyBtn.textContent='Copy',1200);
      }catch(e){alert('Unable to copy: '+e.message);}
    });

    const inputs=[latEl,lonEl,satLonEl,headingEl];
    inputs.forEach((el,idx)=>{
      el.addEventListener('input',()=>updateAll());
      el.addEventListener('keydown',e=>{
        if(e.key==='Enter'){
          normalizeInput(el, el===latEl?90:(el===headingEl?360:180));
          updateAll();
          if(idx<inputs.length-1){inputs[idx+1].focus();inputs[idx+1].select();}
        }
      });
      el.addEventListener('blur',()=>{normalizeInput(el,el===latEl?90:(el===headingEl?360:180));updateAll();});
      el.addEventListener('focus',e=>setTimeout(()=>e.target.select(),0));
    });

    ;['latDir','lonDir','satLonDir'].forEach(id=>{
      document.getElementById(id).addEventListener('change',()=>updateAll());
    });
  </script>
</body>
</html>
