<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Satellite Calculator Look Angle</title>
  <style>
    :root{font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    body{display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;background:linear-gradient(180deg,#f8fafc,#eef2ff)}
    .card{background:#ffffff;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.08);padding:20px;max-width:600px;width:95%;}
    h1{font-size:18px;margin:0 0 16px;color:#0f172a;text-align:center}
    .coords{display:flex;flex-direction:column;gap:12px;margin-top:12px}
    .coord-item{
      display:grid;
      grid-template-columns: minmax(80px,140px) 1fr auto;
      align-items:center;
      gap:8px;
      background:#f8fafc;
      padding:8px 12px;
      border-radius:8px;
    }
    .coord-item label{margin:0;color:#0f172a;font-weight:500;}
    .coord-item input{
      width:100%;min-width:0;text-align:center;border:none;background:transparent;
      font-size:18px;color:#0f172a;outline:none;appearance:textfield;padding:6px 4px;
    }
    .coord-item input:focus{background:#e0f2fe;border-radius:4px;}
    .coord-item input::-webkit-outer-spin-button,
    .coord-item input::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }
    .coord-item select{
      font-size:16px;padding:6px 8px;border-radius:6px;border:1px solid #cbd5e1;
      background:white;color:#0f172a;min-width:48px;
    }
    .muted{color:#94a3b8;font-size:13px;margin-top:12px;text-align:center}
    .actions{display:flex;gap:8px;margin-top:14px;justify-content:center}
    button{padding:8px 12px;border-radius:8px;border:0;background:#0ea5a4;color:white;cursor:pointer;font-weight:500}
    button.secondary{background:#64748b}
    .error{color:#b91c1c}
    .diagrams{display:flex;flex-wrap:wrap;gap:20px;justify-content:center;margin-top:20px}
    .diagram{display:flex;flex-direction:column;align-items:center}
    canvas{background:white;border-radius:8px;}
    @media (max-width: 600px){
      .diagrams{flex-direction:column;align-items:center}
      canvas{width:100% !important;height:auto !important;max-width:300px}
    }
    @media (min-width: 601px){
      .diagrams{flex-direction:row;justify-content:space-around}
      canvas{width:180px;height:180px}
    }
  </style>
</head>
<body>
  <div class="card" role="region" aria-label="Device coordinates">
    <h1>Satellite Calculator Look Angle</h1>

    <div class="coords" aria-live="polite">
      <div class="coord-item">
        <label for="lat">Latitude</label>
        <input id="lat" type="text" inputmode="decimal" value="38.88" />
        <select id="latDir">
          <option value="N" selected>N</option>
          <option value="S">S</option>
        </select>
      </div>

      <div class="coord-item">
        <label for="lon">Longitude</label>
        <input id="lon" type="text" inputmode="decimal" value="1.40" />
        <select id="lonDir">
          <option value="E" selected>E</option>
          <option value="W">W</option>
        </select>
      </div>

      <div class="coord-item">
        <label for="satLon">Satellite Longitude</label>
        <input id="satLon" type="text" inputmode="decimal" value="18.00" />
        <select id="satLonDir">
          <option value="E">E</option>
          <option value="W" selected>W</option>
        </select>
      </div>

      <div class="coord-item">
        <label for="heading">Heading</label>
        <input id="heading" type="text" inputmode="decimal" value="0.00" />
      </div>
    </div>

    <div class="actions">
      <button id="refreshBtn">Get my location</button>
      <button id="copyBtn" class="secondary" disabled>Copy</button>
    </div>

    <div class="muted" id="status">Waiting for location permission...</div>

<div class="diagrams">
  <div class="diagram">
    <div id="azVal">AZ=</div>
    <div id="elVal">EL=</div>
  </div>
</div>

<div class="diagrams">
  <div class="diagram">
    <div id="relVal">REL=</div>
    <canvas id="relCanvas" width="200" height="200"></canvas>
  </div>
</div>


  <script>
    const latEl=document.getElementById('lat'), lonEl=document.getElementById('lon');
    const latDir=document.getElementById('latDir'), lonDir=document.getElementById('lonDir');
    const satLonEl=document.getElementById('satLon'), satLonDir=document.getElementById('satLonDir');
    const headingEl=document.getElementById('heading');
    const statusEl=document.getElementById('status');
    const refreshBtn=document.getElementById('refreshBtn'), copyBtn=document.getElementById('copyBtn');
    const azVal=document.getElementById('azVal'), elVal=document.getElementById('elVal'), relVal=document.getElementById('relVal');
    const relCtx = relCanvas.getContext('2d');


    function showStatus(msg,isError=false){statusEl.textContent=msg;statusEl.classList.toggle('error',!!isError)}

function normalizeInput(input, max) {
  let val = (input.value || "").trim();

  // Replace comma with dot
  val = val.replace(",", ".");

  // Remove invalid chars (keep only digits, dot, minus)
  val = val.replace(/[^0-9.\-]/g, "");

  // If multiple dots, keep only the first
  const parts = val.split(".");
  if (parts.length > 2) {
    val = parts[0] + "." + parts.slice(1).join("");
  }

  // Parse to float
  let num = parseFloat(val);
  if (isNaN(num)) {
    input.value = "";
    return;
  }

  // Clamp value
  if (num > max) num = max;
  if (num < 0) num = 0;

  // Update field
  input.value = num.toFixed(2);
}


function getLatLon(){
  const latVal = parseFloat((latEl.value || "").trim().replace(",", ".")) || 0;
  const lonVal = parseFloat((lonEl.value || "").trim().replace(",", ".")) || 0;
  const satLonVal = parseFloat((satLonEl.value || "").trim().replace(",", ".")) || 0;
  const headingVal = parseFloat((headingEl.value || "").trim().replace(",", ".")) || 0;

  const lat = latDir.value === "N" ? latVal : -latVal;
  const lon = lonDir.value === "E" ? lonVal : -lonVal;
  const satLon = satLonDir.value === "E" ? satLonVal : -satLonVal;

  return { lat, lon, satLon, heading: headingVal };
}


    function calcAzEl(lat,lon,satLon){
      const Re=6378.137,h=35786.0;
      const latR=lat*Math.PI/180, lonR=lon*Math.PI/180, satLonR=satLon*Math.PI/180;
      const xObs=Re*Math.cos(latR)*Math.cos(lonR), yObs=Re*Math.cos(latR)*Math.sin(lonR), zObs=Re*Math.sin(latR);
      const xSat=(Re+h)*Math.cos(satLonR), ySat=(Re+h)*Math.sin(satLonR), zSat=0;
      const dx=xSat-xObs, dy=ySat-yObs, dz=zSat-zObs;
      const e=-Math.sin(lonR)*dx+Math.cos(lonR)*dy;
      const n=-Math.sin(latR)*Math.cos(lonR)*dx -Math.sin(latR)*Math.sin(lonR)*dy +Math.cos(latR)*dz;
      const u=Math.cos(latR)*Math.cos(lonR)*dx +Math.cos(latR)*Math.sin(lonR)*dy +Math.sin(latR)*dz;
      let az=Math.atan2(e,n)*180/Math.PI; if(az<0)az+=360;
      const el=Math.atan2(u,Math.sqrt(e*e+n*n))*180/Math.PI;
      return {az,el};
    }



    const vesselImg=new Image();vesselImg.src="https://pgarciafer.github.io/satcalc/IMG_0585.PNG";
    function drawRel(rel){
      relCtx.clearRect(0,0,200,200);relVal.textContent='REL='+rel.toFixed(2);
      if(!vesselImg.complete){vesselImg.onload=()=>drawRel(rel);return;}
      relCtx.save();relCtx.translate(100,100);relCtx.drawImage(vesselImg,-110,-110,220,220);relCtx.restore();
      const rad=(rel-90)*Math.PI/180;relCtx.strokeStyle='blue';relCtx.lineWidth=2;relCtx.beginPath();relCtx.moveTo(100,100);relCtx.lineTo(100+70*Math.cos(rad),100+70*Math.sin(rad));relCtx.stroke();
    }

    function updateAll(){
      const {lat,lon,satLon,heading}=getLatLon();
      const {az,el}=calcAzEl(lat,lon,satLon);
 azVal.textContent='AZ='+az.toFixed(2);
elVal.textContent='EL='+el.toFixed(2);

      const rel=((az-heading)+360)%360;drawRel(rel);
      copyBtn.disabled=false;
    }

    async function getAndShowLocation(){
      showStatus('Requesting location...');copyBtn.disabled=true;
      if(!('geolocation' in navigator)){showStatus('Geolocation API not supported.',true);return;}
      const opts={enableHighAccuracy:true,maximumAge:0,timeout:20000};
      return new Promise(resolve=>{
        navigator.geolocation.getCurrentPosition(pos=>{
          const c=pos.coords;
          latEl.value=Math.abs(c.latitude).toFixed(2);latDir.value=c.latitude>=0?'N':'S';
          lonEl.value=Math.abs(c.longitude).toFixed(2);lonDir.value=c.longitude>=0?'E':'W';
          copyBtn.disabled=false;showStatus(`Location loaded (±${Math.round(c.accuracy)} m).`);updateAll();resolve(c);
        },err=>{showStatus('Location error: '+err.message,true);resolve(null);},opts);
      });
    }

    refreshBtn.addEventListener('click',()=>{getAndShowLocation();});
    copyBtn.addEventListener('click',async()=>{
      const {lat,lon,satLon,heading}=getLatLon();
      const {az,el}=calcAzEl(lat,lon,satLon);
      const rel=((az-heading)+360)%360;
      const text=`Lat: ${Math.abs(lat).toFixed(2)}°${lat>=0?'N':'S'}, Lon: ${Math.abs(lon).toFixed(2)}°${lon>=0?'E':'W'}, Sat: ${Math.abs(satLon).toFixed(2)}°${satLon>=0?'E':'W'}\nAZ=${az.toFixed(2)}°, EL=${el.toFixed(2)}°, REL=${rel.toFixed(2)}°`;
      try{await navigator.clipboard.writeText(text);copyBtn.textContent='Copied!';setTimeout(()=>copyBtn.textContent='Copy',1200);}catch(e){alert('Unable to copy: '+e.message);}
    });

    const inputs=[latEl,lonEl,satLonEl,headingEl];
    inputs.forEach((el,idx)=>{
      el.addEventListener('input',()=>updateAll());
      el.addEventListener('keydown',e=>{if(e.key==='Enter'){normalizeInput(el,el===latEl?90:(el===headingEl?360:180));updateAll();if(idx<inputs.length-1){inputs[idx+1].focus();inputs[idx+1].select();}}});
      el.addEventListener('blur',()=>{normalizeInput(el,el===latEl?90:(el===headingEl?360:180));updateAll();});
      el.addEventListener('focus',e=>setTimeout(()=>e.target.select(),0));
    });
    ['latDir','lonDir','satLonDir'].forEach(id=>{document.getElementById(id).addEventListener('change',()=>updateAll());});
    window.addEventListener('DOMContentLoaded',()=>{updateAll();});
  </script>
</body>
</html>
