<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Satellite Calculator Look Angle</title>
  <style>
    :root{font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    body{display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;background:linear-gradient(180deg,#f8fafc,#eef2ff)}
    .card{background:#ffffff;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.08);padding:20px;max-width:600px;width:95%;}
    h1{font-size:18px;margin:0 0 16px;color:#0f172a;text-align:center}
    .coords{display:flex;flex-direction:column;gap:12px;margin-top:12px}
    .coord-item{
      display:grid;
      grid-template-columns: minmax(80px,140px) 1fr auto;
      align-items:center;
      gap:8px;
      background:#f8fafc;
      padding:8px 12px;
      border-radius:8px;
    }
    .coord-item label{margin:0;color:#0f172a;font-weight:500;}
    .coord-item input{
      width:100%;min-width:0;text-align:center;border:none;background:transparent;
      font-size:18px;color:#0f172a;outline:none;appearance:textfield;padding:6px 4px;
    }
    .coord-item input:focus{background:#e0f2fe;border-radius:4px;}
    .coord-item input::-webkit-outer-spin-button,
    .coord-item input::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }
    .coord-item select{
      font-size:16px;padding:6px 8px;border-radius:6px;border:1px solid #cbd5e1;
      background:white;color:#0f172a;min-width:48px;
    }
    .muted{color:#94a3b8;font-size:13px;margin-top:12px;text-align:center}
    .actions{display:flex;gap:8px;margin-top:14px;justify-content:center}
    button{padding:8px 12px;border-radius:8px;border:0;background:#0ea5a4;color:white;cursor:pointer;font-weight:500}
    button.secondary{background:#64748b}
    button.small{padding:4px 8px;font-size:13px}
    .error{color:#b91c1c}
    .blocking-section{margin-top:12px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{text-align:center;padding:6px;border-bottom:1px solid #e2e8f0}
    th{color:#0f172a;font-weight:600}
    td input{width:90px;text-align:center}
    .diagrams{display:flex;flex-wrap:wrap;gap:20px;justify-content:center;margin-top:20px}
    .diagram{display:flex;flex-direction:column;align-items:center}
    canvas{background:white;border-radius:8px;}
    @media (max-width: 600px){
      .diagrams{flex-direction:column;align-items:center}
      canvas{width:100% !important;height:auto !important;max-width:300px}
    }
    @media (min-width: 601px){
      .diagrams{flex-direction:row;justify-content:space-around}
      canvas{width:180px;height:180px}
    }
  </style>
</head>
<body>
  <div class="card" role="region" aria-label="Device coordinates">
    <h1>Satellite Calculator Look Angle</h1>

    <div class="coords" aria-live="polite">
      <div class="coord-item">
        <label for="lat">Latitude</label>
        <input id="lat" type="text" inputmode="decimal" value="38.88" />
        <select id="latDir"><option value="N" selected>N</option><option value="S">S</option></select>
      </div>

      <div class="coord-item">
        <label for="lon">Longitude</label>
        <input id="lon" type="text" inputmode="decimal" value="1.40" />
        <select id="lonDir"><option value="E" selected>E</option><option value="W">W</option></select>
      </div>

      <div class="coord-item">
        <label for="satLon">Satellite Longitude</label>
        <input id="satLon" type="text" inputmode="decimal" value="18.00" />
        <select id="satLonDir"><option value="E">E</option><option value="W" selected>W</option></select>
      </div>

      <div class="coord-item">
        <label for="heading">Heading</label>
        <input id="heading" type="text" inputmode="decimal" value="0.00" />
      </div>

      <!-- Blocking Zones -->
      <div class="coord-item" id="blockingZonesSection" style="display:block; grid-template-columns:1fr;">
        <label style="font-weight:600;">Blocking Zones</label>
        <button type="button" id="addBlockBtn">Add Blocking Zone</button>
        <table id="zonesTable" style="display:none;">
          <thead>
            <tr>
              <th>AZ Start</th>
              <th>AZ Stop</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="zonesBody"></tbody>
        </table>
      </div>
    </div>

    <div class="actions">
      <button id="refreshBtn">Get my location</button>
      <button id="copyBtn" class="secondary" disabled>Copy</button>
    </div>

    <div class="muted" id="status">Waiting for location permission...</div>

    <div class="diagrams">
      <div class="diagram">
        <div id="azVal">AZ=</div>
        <div id="elVal">EL=</div>
      </div>
    </div>

    <div class="diagrams">
      <div class="diagram">
        <div id="relVal">REL=</div>
        <div id="blockMsg" style="color:red; font-size:13px; display:none;"></div>
        <canvas id="relCanvas" width="200" height="200"></canvas>
      </div>
    </div>

  <script>
  const relCanvas=document.getElementById("relCanvas");
  const relCtx=relCanvas.getContext('2d');
  const blockMsg=document.getElementById("blockMsg");

  const latEl=document.getElementById('lat'), lonEl=document.getElementById('lon');
  const latDir=document.getElementById('latDir'), lonDir=document.getElementById('lonDir');
  const satLonEl=document.getElementById('satLon'), satLonDir=document.getElementById('satLonDir');
  const headingEl=document.getElementById('heading');
  const statusEl=document.getElementById('status');
  const refreshBtn=document.getElementById('refreshBtn'), copyBtn=document.getElementById('copyBtn');
  const azVal=document.getElementById('azVal'), elVal=document.getElementById('elVal'), relVal=document.getElementById('relVal');

  // Blocking zones
  const zonesTable=document.getElementById("zonesTable");
  const zonesBody=document.getElementById("zonesBody");
  const addBlockBtn=document.getElementById("addBlockBtn");
  
const zoneColors = [
    "rgba(255, 0, 0, 0.25)",   // red
    "rgba(0, 128, 255, 0.25)", // blue
    "rgba(0, 200, 0, 0.25)",   // green
    "rgba(255, 165, 0, 0.25)", // orange
    "rgba(128, 0, 128, 0.25)", // purple
    "rgba(255, 20, 147, 0.25)" // pink
  ];

// Draw a blocking zone (absolute, not heading-relative)
function drawZone(start, stop, isActive, index) {
  let startAZ = (start + 360) % 360;
  let stopAZ  = (stop  + 360) % 360;

  if (stopAZ < startAZ) stopAZ += 360;

  const baseColor = zoneColors[(index - 1) % zoneColors.length];
  const fillColor = isActive ? baseColor.replace("0.25", "0.45") : baseColor;

  relCtx.save();
  relCtx.translate(100, 100);
  relCtx.fillStyle = fillColor;

  relCtx.beginPath();
  relCtx.moveTo(0, 0);
  relCtx.arc(
    0, 0, 80,
    (startAZ - 90) * Math.PI / 180,
    (stopAZ  - 90) * Math.PI / 180,
    false
  );
  relCtx.closePath();
  relCtx.fill();
  relCtx.restore();
}

// Draw REL + vessel + zones
function drawRel(rel) {
  relCtx.clearRect(0, 0, 200, 200);

  if (!vesselImg.complete) {
    vesselImg.onload = () => drawRel(rel);
    return;
  }

  relCtx.save();
  relCtx.translate(100, 100);
  relCtx.drawImage(vesselImg, -110, -110, 220, 220);
  relCtx.restore();

  const result = checkBlockingZones(rel);

  const rows = zonesBody.querySelectorAll("tr");
  rows.forEach((row, idx) => {
    const start = parseFloat(row.cells[0].querySelector("input").value);
    const stop  = parseFloat(row.cells[1].querySelector("input").value);
    if (isNaN(start) || isNaN(stop)) return;

    const isActive = (result && result.index === idx + 1);
    drawZone(start, stop, isActive, idx + 1);
  });

  // REL arrow
  const rad = (rel - 90) * Math.PI / 180;
  relCtx.strokeStyle = result 
    ? zoneColors[(result.index - 1) % zoneColors.length].replace("0.25", "1.0")
    : "blue";
  relCtx.lineWidth = 2;
  relCtx.beginPath();
  relCtx.moveTo(100, 100);
  relCtx.lineTo(100 + 70 * Math.cos(rad), 100 + 70 * Math.sin(rad));
  relCtx.stroke();

  if (result) {
    const zoneColor = zoneColors[(result.index - 1) % zoneColors.length].replace("0.25", "1.0");
    blockMsg.textContent = `Entered in block zone `;
    blockMsg.style.display = "block";
    blockMsg.style.color = zoneColor;
  } else {
    blockMsg.style.display = "none";
  }
}

function checkBlockingZones(rel){
  const rows = zonesBody.querySelectorAll("tr");
  let zoneIndex = 0;

  for(const row of rows){
    zoneIndex++;
    const start = parseFloat(row.cells[0].querySelector("input").value);
    const stop  = parseFloat(row.cells[1].querySelector("input").value);
    if(isNaN(start) || isNaN(stop)) continue;

    let startAZ = (start + 360) % 360;
    let stopAZ  = (stop  + 360) % 360;

    if(startAZ <= stopAZ){
      if(rel >= startAZ && rel <= stopAZ){
        return { index: zoneIndex, start, stop };
      }
    } else {
      if(rel >= startAZ || rel <= stopAZ){
        return { index: zoneIndex, start, stop };
      }
    }
  }
  return null;
}

function createZoneRow(start=0.00, stop=0.00){
  const tr=document.createElement("tr");
  tr.innerHTML=`
    <td><input type="number" min="0" max="360" step="0.01" value=""></td>
    <td><input type="number" min="0" max="360" step="0.01" value=""></td>
    <td><button class="small secondary">Remove</button></td>
  `;
  const startInput = tr.querySelector("td:nth-child(1) input");
  const stopInput  = tr.querySelector("td:nth-child(2) input");
  [startInput, stopInput].forEach(inp => {
    inp.addEventListener("input", updateAll);
    inp.addEventListener("blur", () => {
      let val = parseFloat(inp.value);
      if(isNaN(val)) val = 0;
      if(val < 0) val = 0;
      if(val > 360) val = 360;
      inp.value = val.toFixed(2);
      updateAll();
    });
  });
  tr.querySelector("button").addEventListener("click",()=>{
    tr.remove();
    if(zonesBody.children.length===0) zonesTable.style.display="none";
    updateAll();
  });
  zonesBody.appendChild(tr);
  zonesTable.style.display="table";
  updateAll();
}
addBlockBtn.addEventListener("click",()=>createZoneRow());

function showStatus(msg,isError=false){
  statusEl.textContent=msg;
  statusEl.classList.toggle('error',!!isError)
}

function normalizeInput(input, max){
  let val = (input.value || "").trim().replace(",", ".");
  if(val === "") return;
  let num = parseFloat(val);
  if(isNaN(num)) return;
  if(num > max) num = max;
  if(num < 0) num = 0;
  input.value = num.toFixed(2);
}

function getLatLon(){
  const latVal = parseFloat((latEl.value || "").trim().replace(",", ".")) || 0;
  const lonVal = parseFloat((lonEl.value || "").trim().replace(",", ".")) || 0;
  const satLonVal = parseFloat((satLonEl.value || "").trim().replace(",", ".")) || 0;
  const headingVal = parseFloat((headingEl.value || "").trim().replace(",", ".")) || 0;
  const lat = latDir.value === "N" ? latVal : -latVal;
  const lon = lonDir.value === "E" ? lonVal : -lonVal;
  const satLon = satLonDir.value === "E" ? satLonVal : -satLonVal;
  return { lat, lon, satLon, heading: headingVal };
}

function calcAzEl(lat,lon,satLon){
  const Re=6378.137,h=35786.0;
  const latR=lat*Math.PI/180, lonR=lon*Math.PI/180, satLonR=satLon*Math.PI/180;
  const xObs=Re*Math.cos(latR)*Math.cos(lonR), yObs=Re*Math.cos(latR)*Math.sin(lonR), zObs=Re*Math.sin(latR);
  const xSat=(Re+h)*Math.cos(satLonR), ySat=(Re+h)*Math.sin(satLonR), zSat=0;
  const dx=xSat-xObs, dy=ySat-yObs, dz=zSat-zObs;
  const e=-Math.sin(lonR)*dx+Math.cos(lonR)*dy;
  const n=-Math.sin(latR)*Math.cos(lonR)*dx -Math.sin(latR)*Math.sin(lonR)*dy +Math.cos(latR)*dz;
  const u=Math.cos(latR)*Math.cos(lonR)*dx +Math.cos(latR)*Math.sin(lonR)*dy +Math.sin(latR)*dz;
  let az=Math.atan2(e,n)*180/Math.PI; if(az<0)az+=360;
  const el=Math.atan2(u,Math.sqrt(e*e+n*n))*180/Math.PI;
  return {az,el};
}

const vesselImg=new Image();
vesselImg.src="https://pgarciafer.github.io/satcalc/IMG_0585.PNG";

function updateAll(){
  const {lat,lon,satLon,heading}=getLatLon();
  const {az,el}=calcAzEl(lat,lon,satLon);
  azVal.textContent='AZ='+az.toFixed(2);
  elVal.textContent='EL='+el.toFixed(2);
  const rel=((az-heading)+360)%360;
  relVal.textContent='REL='+rel.toFixed(2);
  drawRel(rel);
  copyBtn.disabled=false;
}

async function getAndShowLocation(){
  showStatus('Requesting location...');
  copyBtn.disabled=true;
  if(!('geolocation' in navigator)){
    showStatus('Geolocation API not supported.',true);
    return;
  }
  const opts={enableHighAccuracy:true,maximumAge:0,timeout:20000};
  return new Promise(resolve=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      const c=pos.coords;
      latEl.value=Math.abs(c.latitude).toFixed(2);
      latDir.value=c.latitude>=0?'N':'S';
      lonEl.value=Math.abs(c.longitude).toFixed(2);
      lonDir.value=c.longitude>=0?'E':'W';
      copyBtn.disabled=false;
      showStatus(`Location loaded (± m).`);
      updateAll();
      resolve(c);
    },err=>{
      showStatus('Location error: '+err.message,true);
      resolve(null);
    },opts);
  });
}

refreshBtn.addEventListener('click',()=>{getAndShowLocation();});
copyBtn.addEventListener('click',async()=>{
  const {lat,lon,satLon,heading}=getLatLon();
  const {az,el}=calcAzEl(lat,lon,satLon);
  const rel=((az-heading)+360)%360;
  const text=`Lat: °'S', Lon: °'W', Sat: °'W'\nAZ=°, EL=°, REL=°`;
  try{
    await navigator.clipboard.writeText(text);
    copyBtn.textContent='Copied!';
    setTimeout(()=>copyBtn.textContent='Copy',1200);
  }catch(e){
    alert('Unable to copy: '+e.message);
  }
});

const inputs=[latEl,lonEl,satLonEl,headingEl];
inputs.forEach((el,idx)=>{
  el.addEventListener('input',()=>updateAll());
  el.addEventListener('keydown',e=>{
    if(e.key==='Enter'){
      normalizeInput(el,el===latEl?90:(el===headingEl?360:180));
      updateAll();
      if(idx<inputs.length-1){
        inputs[idx+1].focus();
        inputs[idx+1].select();
      }
    }
  });
  el.addEventListener('blur',()=>{
    normalizeInput(el,el===latEl?90:(el===headingEl?360:180));
    updateAll();
  });
  el.addEventListener('focus',e=>setTimeout(()=>e.target.select(),0));
});
['latDir','lonDir','satLonDir'].forEach(id=>{
  document.getElementById(id).addEventListener('change',()=>updateAll());
});
window.addEventListener('DOMContentLoaded',()=>{updateAll();});
  </script>
</body>